# TODO - ep_docx_preprocessor Plugin

This plugin will handle the conversion of DOCX files to HTML and apply a set of configurable transformations to prepare the HTML for other Etherpad plugins.

## Phase 1: Basic Structure and DOCX to HTML Conversion

-   **[ ] Initialize Plugin (`ep.json`)**
    -   Define basic plugin metadata (name, version, author, description).
    -   Register server-side hooks:
        -   `import`

-   **[ ] Server-Side Logic (`index.js`)**
    -   **[ ] Dependencies:**
        -   `fs` (for file system operations, promisify for async)
        -   `path` (for path manipulation)
        -   `child_process` (for `exec` if calling `soffice`)
        -   `os` (for `tmpdir`)
        -   `log4js` (for logging)
        -   `jsdom` (for DOM manipulation)
        -   `settings` (Etherpad's core settings, to read plugin config)
        -   `util.promisify` for `exec`.

    -   **[ ] `import` Hook Implementation:**
        -   `exports.import = async (hookName, context, cb) => { ... }`
        -   Check `context.fileEnding` for `.docx`, `.doc`. If not, `return false;`.
        -   **LibreOffice Conversion:**
            -   Adopt/adapt the `soffice` command execution logic from `ep_image_insert/index.js`.
                -   Generate temporary input/output paths for `soffice`.
                -   Execute `soffice --headless --convert-to html --outdir <tmp_dir> <docx_srcFile>`.
                -   Ensure robust error handling for `soffice` call.
            -   Read the HTML content generated by `soffice`.
        -   For now, just write this raw HTML to `context.destFile`.
            -   `await fs.promises.copyFile(sofficeOutputFile, context.destFile);`
        -   `return true;` to indicate the hook handled the import.
        -   Add logging for each step.

## Phase 2: Configurable Transformation Engine

-   **[ ] Define Configuration Schema (`settings.json`)**
    -   Determine how users will define transformation rules. Example structure within `settings.json` under `ep_docx_preprocessor`:
        ```json
        "ep_docx_preprocessor": {
          "transformations": [
            {
              "name": "Convert Images for ep_image_insert",
              "selector": "img",
              "action": "replaceWithSpans", // Custom action identifier
              "params": { // Parameters specific to this action
                "outerSpanBaseClasses": "inline-image character image-placeholder",
                "innerSpanClass": "image-inner",
                "srcClassPrefix": "image:",
                "widthClassPrefix": "image-width:",
                "heightClassPrefix": "image-height:",
                "aspectRatioClassPrefix": "imageCssAspectRatio:",
                "addResizeHandles": true,
                "addZwspPadding": true
              }
            },
            {
              "name": "Convert Tables for ep_tables_plugin",
              "selector": "table",
              "action": "customTableTransform", // Another action
              "params": { /* ... table specific params ... */ }
            }
            // More rules can be added
          ]
        }
        ```

-   **[ ] Implement Transformation Logic in `index.js` (`import` hook):**
    -   After `soffice` conversion, parse the HTML using `JSDOM`: `const dom = new JSDOM(htmlFromSoffice); const document = dom.window.document;`
    -   Read transformation rules from `settings.json`.
    -   Loop through each rule:
        -   `const elements = document.querySelectorAll(rule.selector);`
        -   For each found element:
            -   Implement a dispatcher or a series of `if/else if` based on `rule.action`.
            -   **Example `replaceWithSpans` action (for images):**
                -   This function will take the `imgElement (JSDOM)` and `rule.params`.
                -   Extract `src`, `width`, `height` from `imgElement`.
                -   Handle relative image paths: resolve against `path.dirname(sofficeOutputFile)`, read image, convert to base64.
                -   Construct the nested `<span>` structure as `ep_image_insert` expects, using `document.createElement`, `setAttribute`, `classList.add`, `appendChild`, `createTextNode`.
                -   (Crucially, the classes like `image:<encoded_src>` must match what `ep_image_insert/static/js/contentCollection.js` expects).
                -   Replace the original `imgElement` with the new `<span>` structure (and ZWSP padding if configured).
            -   Implement other action handlers as needed (e.g., `customTableTransform`).
    -   Serialize the modified `document` back to HTML: `const finalHtml = dom.serialize();`
    -   Write `finalHtml` to `context.destFile`.

## Phase 3: Refactor `ep_image_insert` (and other plugins)

-   **[ ] Modify `ep_image_insert/index.js`:**
    -   **Remove DOCX-specific `import` logic:** Delete the `if (fileEnding === '.doc' || ...)` block that calls `soffice` and does JSDOM manipulation for images.
    -   The `import` hook in `ep_image_insert` might now:
        -   Only handle direct HTML uploads (`if (fileEnding === '.html' || fileEnding === '.htm')`) if any special processing is *still* needed for images in directly uploaded HTML (e.g., path resolving if not already handled by the browser or if server-side intervention is desired for some reason).
        -   Or, it might simply `return false;` for all file types, fully relying on `collectContentPre` (server-side version) to pick up attributes from HTML prepared by any import mechanism (including `ep_docx_preprocessor`).
    -   Review if `exports.ccRegisterBlockElements = () => ['img'];` is still necessary if `ep_docx_preprocessor` entirely replaces `<img>` tags from DOCX. It might still be useful for direct HTML paste or other scenarios.

-   **[ ] Verify `ep_image_insert/static/js/contentCollection.js`:**
    -   Ensure `collectContentPre` correctly parses the classes (e.g., `image:<encoded_src>`, `image-width:100px`) set by the new `ep_docx_preprocessor` and converts them to the `key::value` format for `context.cc.doAttrib`.

-   **[ ] (Future) For `ep_tables_plugin` (and others):**
    -   They would *not* implement DOCX `soffice` logic in their `import` hooks.
    -   They would rely on `ep_docx_preprocessor` to have transformed `<table>` elements (or other relevant structures from DOCX) into the custom HTML representation the table plugin expects.
    -   Their `collectContentPre` (or similar server-side attribute collection hook) would be responsible for parsing this custom HTML structure (e.g., specific classes or data attributes on `div`s representing cells/rows) into Etherpad attributes.
    -   Their `exportHTML.js` would convert these attributes back to standard HTML `<table>`s or their desired export format.

## Phase 4: Documentation and Testing

-   **[ ] Create `README.md` for `ep_docx_preprocessor`:**
    -   Explain its purpose and how it decouples DOCX processing.
    -   Detail the `settings.json` configuration schema for transformations.
    -   Provide examples for common use cases (e.g., image conversion).
-   **[ ] Testing:**
    -   Test DOCX import with images: ensure `ep_docx_preprocessor` converts them and `ep_image_insert` displays them.
    -   Test direct HTML import with images (ensure `ep_image_insert` still works if its `import` hook is simplified/removed for DOCX).
    -   Test with DOCX files containing elements not covered by transformation rules (they should pass through as standard HTML or be ignored by `soffice`).
    -   Test error conditions (e.g., `soffice` failure, invalid configuration). 